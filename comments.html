<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Reflections — The Story of Yusuf</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Frank+Ruhl+Libre:wght@300;400;500;700&family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* ── Reset ── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ── Shared variables ── */
:root {
  --gold: #c9a84c;
  --gold-light: #e8d9a0;
  --deep-blue: #1a3a5c;
  --teal: #1a6b5a;
  --cream: #faf6ed;
  --text-dark: #2c2416;
  --verse-num: #8a7a5a;
  --border-width: 32px;
}

body {
  background: var(--deep-blue);
  font-family: 'Cormorant Garamond', Georgia, serif;
  color: var(--text-dark);
  line-height: 1.7;
  min-height: 100vh;
}

/* ── Islamic geometric border frame ── */
.islamic-border {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none;
  z-index: 100;
  background:
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Crect width='64' height='64' fill='%231a3a5c'/%3E%3Cpolygon points='32,4 37,20 52,12 44,27 60,32 44,37 52,52 37,44 32,60 27,44 12,52 20,37 4,32 20,27 12,12 27,20' fill='none' stroke='%23c9a84c' stroke-width='1.2' opacity='0.7'/%3E%3Cpolygon points='32,16 42,22 48,32 42,42 32,48 22,42 16,32 22,22' fill='none' stroke='%23c9a84c' stroke-width='0.8' opacity='0.5'/%3E%3Ccircle cx='32' cy='32' r='2.5' fill='%23c9a84c' opacity='0.6'/%3E%3Cline x1='0' y1='0' x2='20' y2='20' stroke='%23c9a84c' stroke-width='0.5' opacity='0.3'/%3E%3Cline x1='64' y1='0' x2='44' y2='20' stroke='%23c9a84c' stroke-width='0.5' opacity='0.3'/%3E%3Cline x1='0' y1='64' x2='20' y2='44' stroke='%23c9a84c' stroke-width='0.5' opacity='0.3'/%3E%3Cline x1='64' y1='64' x2='44' y2='44' stroke='%23c9a84c' stroke-width='0.5' opacity='0.3'/%3E%3C/svg%3E");
  -webkit-mask-image:
    linear-gradient(to bottom, black var(--border-width), transparent var(--border-width), transparent calc(100% - var(--border-width)), black calc(100% - var(--border-width))),
    linear-gradient(to right, black var(--border-width), transparent var(--border-width), transparent calc(100% - var(--border-width)), black calc(100% - var(--border-width)));
  mask-image:
    linear-gradient(to bottom, black var(--border-width), transparent var(--border-width), transparent calc(100% - var(--border-width)), black calc(100% - var(--border-width))),
    linear-gradient(to right, black var(--border-width), transparent var(--border-width), transparent calc(100% - var(--border-width)), black calc(100% - var(--border-width)));
}

.page-wrapper::before {
  content: '';
  position: absolute;
  inset: -2px;
  border: 2px solid var(--gold);
  border-radius: 2px;
  pointer-events: none;
  z-index: 10;
}

.page-wrapper {
  margin: var(--border-width);
  background: var(--cream);
  min-height: calc(100vh - var(--border-width) * 2);
  position: relative;
}

/* ── Header ── */
.page-header {
  text-align: center;
  padding: 50px 40px 30px;
  border-bottom: 2px solid var(--gold);
  background: linear-gradient(180deg, #f7f0df 0%, var(--cream) 100%);
}

.page-header h1 {
  font-size: 2.2rem;
  font-weight: 600;
  color: var(--deep-blue);
  margin-bottom: 4px;
  letter-spacing: 0.02em;
}

.page-header .subtitle {
  font-size: 1.05rem;
  color: var(--verse-num);
  font-style: italic;
}

.back-link {
  display: inline-block;
  margin-bottom: 16px;
  font-size: 0.85rem;
  color: var(--gold);
  text-decoration: none;
  letter-spacing: 0.04em;
  transition: color 0.2s;
}

.back-link:hover { color: var(--teal); }

.ornament {
  text-align: center;
  padding: 8px 0;
  color: var(--gold);
  font-size: 1.4rem;
  letter-spacing: 0.5em;
  user-select: none;
}

/* ── Language Toggle ── */
.lang-toggle {
  text-align: center;
  padding: 12px 20px 0;
}

.lang-toggle-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--verse-num);
  font-family: sans-serif;
  margin-bottom: 6px;
}

.lang-toggle-btns {
  display: inline-flex;
  border: 1px solid var(--gold);
  border-radius: 4px;
  overflow: hidden;
}

.lang-toggle-btns button {
  font-family: 'Cormorant Garamond', Georgia, serif;
  font-size: 0.9rem;
  padding: 5px 18px;
  border: none;
  background: transparent;
  color: var(--deep-blue);
  cursor: pointer;
  transition: background 0.2s, color 0.2s;
}

.lang-toggle-btns button + button {
  border-left: 1px solid var(--gold);
}

.lang-toggle-btns button.active-lang {
  background: var(--gold);
  color: white;
}

.lang-toggle-btns button:hover:not(.active-lang) {
  background: var(--gold-light);
}

/* ── Footer ── */
.page-footer {
  text-align: center;
  padding: 30px 20px;
  color: var(--verse-num);
  font-size: 0.85rem;
  border-top: 2px solid var(--gold);
}

.page-footer a {
  color: var(--gold);
  text-decoration: none;
}

.page-footer a:hover { color: var(--teal); }

/* ── Comment Form ── */
.comment-form-section {
  max-width: 620px;
  margin: 0 auto;
  padding: 36px 30px;
}

.comment-form-section h2 {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--teal);
  text-align: center;
  margin-bottom: 20px;
}

.form-row {
  margin-bottom: 16px;
}

.form-row label {
  display: block;
  font-size: 0.78rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--verse-num);
  font-family: sans-serif;
  margin-bottom: 4px;
}

.form-row input,
.form-row textarea,
.form-row select {
  width: 100%;
  font-family: 'Cormorant Garamond', Georgia, serif;
  font-size: 1rem;
  padding: 10px 12px;
  border: 1px solid var(--gold-light);
  border-radius: 4px;
  background: white;
  color: var(--text-dark);
  transition: border-color 0.2s;
}

.form-row input:focus,
.form-row textarea:focus,
.form-row select:focus {
  outline: none;
  border-color: var(--gold);
}

.form-row textarea {
  resize: vertical;
  min-height: 100px;
}

.form-row select {
  cursor: pointer;
}

.submit-btn {
  display: block;
  width: 100%;
  font-family: 'Cormorant Garamond', Georgia, serif;
  font-size: 1.05rem;
  font-weight: 600;
  padding: 12px 24px;
  background: var(--gold);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  letter-spacing: 0.05em;
  transition: background 0.2s, opacity 0.2s;
}

.submit-btn:hover { background: #b8963f; }

.submit-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.form-message {
  text-align: center;
  margin-top: 10px;
  font-size: 0.9rem;
  font-style: italic;
}

.form-message.success { color: var(--teal); }
.form-message.error { color: #a04040; }

/* ── Private message checkbox ── */
.private-check-row {
  margin-bottom: 16px;
}
.private-label {
  display: flex;
  align-items: flex-start;
  gap: 8px;
  cursor: pointer;
  font-size: 0.88rem;
  color: var(--verse-num);
  font-family: 'Cormorant Garamond', Georgia, serif;
  text-transform: none;
  letter-spacing: normal;
}
.private-label input[type="checkbox"] {
  margin-top: 3px;
  accent-color: var(--gold);
  cursor: pointer;
}

/* ── Category Sections ── */
.comments-display {
  padding: 10px 30px 40px;
  max-width: 760px;
  margin: 0 auto;
}

.category-section {
  margin-bottom: 12px;
  border: 1px solid var(--gold-light);
  border-radius: 6px;
  overflow: hidden;
}

.category-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  cursor: pointer;
  user-select: none;
  transition: background 0.2s;
}

.category-header:hover {
  background: rgba(201, 168, 76, 0.08);
}

.category-header h3 {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--deep-blue);
  display: flex;
  align-items: center;
  gap: 10px;
}

.category-icon {
  font-size: 1.1rem;
}

.category-count {
  font-size: 0.72rem;
  font-family: sans-serif;
  color: var(--verse-num);
  background: rgba(201, 168, 76, 0.15);
  padding: 2px 8px;
  border-radius: 10px;
  margin-left: 8px;
}

.collapse-arrow {
  font-size: 0.8rem;
  color: var(--verse-num);
  transition: transform 0.3s;
}

.category-section.open .collapse-arrow {
  transform: rotate(180deg);
}

.category-body {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease;
}

.category-section.open .category-body {
  max-height: 5000px;
}

.category-body-inner {
  padding: 4px 20px 20px;
}

.category-placeholder {
  text-align: center;
  color: var(--verse-num);
  font-style: italic;
  padding: 16px 0;
  font-size: 0.9rem;
}

/* ── Comment Card ── */
.comment-card {
  padding: 14px 0;
  border-bottom: 1px solid rgba(201, 168, 76, 0.2);
}

.comment-card:last-child {
  border-bottom: none;
}

.comment-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}

.comment-author {
  font-weight: 600;
  color: var(--deep-blue);
  font-size: 1rem;
}

.comment-time {
  font-size: 0.72rem;
  color: var(--verse-num);
  font-family: sans-serif;
}

.comment-text {
  font-size: 1rem;
  line-height: 1.6;
  color: #3a3a3a;
}

/* ── Translation indicators ── */
.translation-note {
  margin-top: 4px;
  font-size: 0.75rem;
  color: var(--verse-num);
  font-style: italic;
  display: flex;
  align-items: center;
  gap: 8px;
}

.toggle-original-btn {
  background: none;
  border: none;
  color: var(--gold);
  cursor: pointer;
  font-size: 0.75rem;
  font-family: 'Cormorant Garamond', Georgia, serif;
  text-decoration: underline;
  padding: 0;
}

.toggle-original-btn:hover {
  color: var(--teal);
}

.comment-translation-status {
  display: block;
  font-size: 0.78rem;
  font-style: italic;
  color: var(--verse-num);
  margin-top: 4px;
}

/* ── Loading state ── */
.loading-comments {
  text-align: center;
  padding: 30px 20px;
  color: var(--verse-num);
  font-style: italic;
}

/* ── RTL adjustments ── */
[dir="rtl"] .comment-meta { flex-direction: row-reverse; }
[dir="rtl"] .category-header { flex-direction: row-reverse; }
[dir="rtl"] .private-label { flex-direction: row-reverse; }
[dir="rtl"] .category-count { margin-left: 0; margin-right: 8px; }
[dir="rtl"] .form-row label { text-align: right; }
[dir="rtl"] .form-row input,
[dir="rtl"] .form-row textarea,
[dir="rtl"] .form-row select { text-align: right; direction: rtl; }
[dir="rtl"] .translation-note { flex-direction: row-reverse; }
[dir="rtl"] .collapse-arrow { order: -1; }

/* ── Responsive ── */
@media (max-width: 900px) {
  :root { --border-width: 16px; }
  .page-header h1 { font-size: 1.7rem; }
  .comment-form-section { padding: 24px 20px; }
  .comments-display { padding: 10px 16px 30px; }
}

@media (max-width: 500px) {
  :root { --border-width: 10px; }
  .page-header { padding: 24px 16px 20px; }
  .page-header h1 { font-size: 1.4rem; }
  .category-header { padding: 12px 14px; }
  .category-body-inner { padding: 4px 14px 16px; }
}
</style>
</head>
<body>

<div class="islamic-border"></div>

<div class="page-wrapper">

  <header class="page-header">
    <a href="index.html" class="back-link" id="backLink">&larr; Back to the Story</a>
    <h1 id="pageTitle">Reflections</h1>
    <div class="subtitle" id="pageSubtitle">Thoughts and reflections from readers of The Story of Yusuf</div>
    <div class="ornament">&#x2726; &#x2726; &#x2726;</div>
    <div class="lang-toggle">
      <div class="lang-toggle-label" id="langLabel">Translation Language</div>
      <div class="lang-toggle-btns" id="langToggle">
        <button class="active-lang" data-lang="en">English</button>
        <button data-lang="fa">&#x0641;&#x0627;&#x0631;&#x0633;&#x06CC; (Persian)</button>
      </div>
    </div>
  </header>

  <!-- Comment Form -->
  <section class="comment-form-section">
    <h2 id="formTitle">Share Your Reflection</h2>
    <form id="commentForm" autocomplete="off">
      <div class="form-row">
        <label for="nameInput" id="nameLabel">Your First Name</label>
        <input type="text" id="nameInput" maxlength="30" placeholder="e.g. Ahmad" required>
      </div>
      <div class="form-row" id="categoryRow">
        <label for="categorySelect" id="categoryLabel">Category</label>
        <select id="categorySelect" required>
          <option value="positive">Positive Feedback</option>
          <option value="differences">Differences in the Stories</option>
          <option value="insights">Insights About Reality</option>
          <option value="other">Other</option>
        </select>
      </div>
      <div class="form-row">
        <label for="commentInput" id="reflectionLabel">Your Reflection</label>
        <textarea id="commentInput" maxlength="500" placeholder="Share your thoughts..." required></textarea>
      </div>
      <div class="form-row private-check-row">
        <label class="private-label">
          <input type="checkbox" id="privateCheck">
          <span id="privateLabel">Send privately to the site creator (not posted publicly)</span>
        </label>
      </div>
      <div class="form-row" id="replyEmailRow" style="display: none;">
        <label for="replyEmail" id="emailLabel">Your Email (optional — if you'd like a reply)</label>
        <input type="email" id="replyEmail" maxlength="100" placeholder="e.g. name@example.com">
      </div>
      <button type="submit" class="submit-btn" id="submitBtn">Submit Reflection</button>
      <div id="formMessage" class="form-message"></div>
    </form>
  </section>

  <!-- Comments Display -->
  <section class="comments-display">
    <div id="commentsContainer">
      <div class="loading-comments">Loading reflections&hellip;</div>
    </div>
  </section>

  <footer class="page-footer">
    <p><a href="index.html" id="footerLink">&larr; Return to The Story of Yusuf</a></p>
  </footer>

</div>

<!-- Firebase SDK (compat) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
// ── Firebase Configuration ──
const firebaseConfig = {
  apiKey: "AIzaSyB4v4eDixGY0SRgFjHgplZdlmkNSX9vsmA",
  authDomain: "yusuf-comments.firebaseapp.com",
  databaseURL: "https://yusuf-comments-default-rtdb.firebaseio.com",
  projectId: "yusuf-comments",
  storageBucket: "yusuf-comments.firebasestorage.app",
  messagingSenderId: "1008260663795",
  appId: "1:1008260663795:web:d0f73dcc95448854362a86",
  measurementId: "G-PVE0B40T1X"
};

let db = null;
let commentsRef = null;
let firebaseReady = false;

// Only initialize Firebase if the config has been filled in
if (firebaseConfig.databaseURL && !firebaseConfig.databaseURL.includes('YOUR_')) {
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    commentsRef = db.ref('comments');
    firebaseReady = true;
  } catch (err) {
    console.warn('Firebase initialization error:', err.message);
  }
} else {
  console.info('Firebase not configured yet. Replace placeholder values in comments.html.');
}

// ── EmailJS Configuration ──
const EMAILJS_PUBLIC_KEY = 'lhj_EjimaMfRct6Er';
const EMAILJS_SERVICE_ID = 'service_1inc2xk';
const EMAILJS_TEMPLATE_ID = 'template_4hp2w6k';
let emailjsReady = false;

if (EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY') {
  try {
    emailjs.init(EMAILJS_PUBLIC_KEY);
    emailjsReady = true;
  } catch (err) {
    console.warn('EmailJS initialization error:', err.message);
  }
}

// ── Language State: URL param > localStorage > default ──
const _urlLang = new URLSearchParams(window.location.search).get('lang');
let currentLang = (_urlLang === 'fa' || _urlLang === 'en') ? _urlLang : (localStorage.getItem('lang') || 'en');
if (_urlLang) localStorage.setItem('lang', currentLang);
let latestSnapshot = null;

// ── I18N Translations ──
const COMMENTS_I18N = {
  en: {
    backLink: '\u2190 Back to the Story',
    pageTitle: 'Reflections',
    pageSubtitle: 'Thoughts and reflections from readers of The Story of Yusuf',
    translationLabel: 'Translation Language',
    formTitle: 'Share Your Reflection',
    nameLabel: 'Your First Name',
    namePlaceholder: 'e.g. Ahmad',
    categoryLabel: 'Category',
    catPositive: 'Positive Feedback',
    catDifferences: 'Differences in the Stories',
    catInsights: 'Insights About Reality',
    catOther: 'Other',
    reflectionLabel: 'Your Reflection',
    reflectionPlaceholder: 'Share your thoughts...',
    privateLabel: 'Send privately to the site creator (not posted publicly)',
    emailLabel: 'Your Email (optional \u2014 if you\'d like a reply)',
    emailPlaceholder: 'e.g. name@example.com',
    submitBtn: 'Submit Reflection',
    submitPrivateBtn: 'Send Private Message',
    submitting: 'Submitting...',
    noReflections: 'No reflections yet in this category.',
    loadingReflections: 'Loading reflections\u2026',
    rateLimit: 'Please wait {wait} seconds before submitting again.',
    missingFields: 'Please fill in your name and reflection.',
    tooLong: 'Name must be under 30 characters and reflection under 500.',
    privateNotConfigured: 'Private messaging is not yet configured.',
    sendFailed: 'Could not send message. Please try again later.',
    firebaseNotReady: 'Comments are not yet connected. Firebase setup is required.',
    submitFailed: 'Could not submit. Please check your connection and try again.',
    privateSent: 'Your private message has been sent. Thank you!',
    publicSent: 'Thank you for sharing your reflection!',
    loadFailed: 'Could not load reflections. Please try again later.',
    footerLink: '\u2190 Return to The Story of Yusuf',
    justNow: 'just now',
    oneMinuteAgo: '1 minute ago',
    minutesAgo: '{N} minutes ago',
    oneHourAgo: '1 hour ago',
    hoursAgo: '{N} hours ago',
    yesterday: 'yesterday',
    daysAgo: '{N} days ago',
    oneMonthAgo: '1 month ago',
    monthsAgo: '{N} months ago',
    translatedFrom: 'Translated from English',
    translatedFromFa: 'Translated from Persian',
    showOriginal: 'Show original',
    showTranslation: 'Show translation',
    translating: 'Translating...',
    translationFailed: 'Translation unavailable'
  },
  fa: {
    backLink: '\u2190 \u0628\u0627\u0632\u06AF\u0634\u062A \u0628\u0647 \u062F\u0627\u0633\u062A\u0627\u0646',
    pageTitle: '\u062A\u0627\u0645\u0644\u0627\u062A',
    pageSubtitle: '\u0627\u0646\u062F\u06CC\u0634\u0647\u200C\u0647\u0627 \u0648 \u062A\u0627\u0645\u0644\u0627\u062A \u062E\u0648\u0627\u0646\u0646\u062F\u06AF\u0627\u0646 \u062F\u0627\u0633\u062A\u0627\u0646 \u06CC\u0648\u0633\u0641',
    translationLabel: '\u0632\u0628\u0627\u0646 \u062A\u0631\u062C\u0645\u0647',
    formTitle: '\u062A\u0627\u0645\u0644 \u062E\u0648\u062F \u0631\u0627 \u0628\u0647 \u0627\u0634\u062A\u0631\u0627\u06A9 \u0628\u06AF\u0630\u0627\u0631\u06CC\u062F',
    nameLabel: '\u0646\u0627\u0645 \u06A9\u0648\u0686\u06A9 \u0634\u0645\u0627',
    namePlaceholder: '\u0645\u062B\u0644\u0627 \u0627\u062D\u0645\u062F',
    categoryLabel: '\u062F\u0633\u062A\u0647\u200C\u0628\u0646\u062F\u06CC',
    catPositive: '\u0628\u0627\u0632\u062E\u0648\u0631\u062F \u0645\u062B\u0628\u062A',
    catDifferences: '\u062A\u0641\u0627\u0648\u062A\u200C\u0647\u0627\u06CC \u062F\u0627\u0633\u062A\u0627\u0646\u200C\u0647\u0627',
    catInsights: '\u0628\u06CC\u0646\u0634\u200C\u0647\u0627\u06CC\u06CC \u062F\u0631\u0628\u0627\u0631\u0647 \u062D\u0642\u06CC\u0642\u062A',
    catOther: '\u0633\u0627\u06CC\u0631',
    reflectionLabel: '\u062A\u0627\u0645\u0644 \u0634\u0645\u0627',
    reflectionPlaceholder: '\u0627\u0646\u062F\u06CC\u0634\u0647\u200C\u0647\u0627\u06CC \u062E\u0648\u062F \u0631\u0627 \u0628\u0647 \u0627\u0634\u062A\u0631\u0627\u06A9 \u0628\u06AF\u0630\u0627\u0631\u06CC\u062F...',
    privateLabel: '\u0627\u0631\u0633\u0627\u0644 \u062E\u0635\u0648\u0635\u06CC \u0628\u0647 \u0633\u0627\u0632\u0646\u062F\u0647 \u0633\u0627\u06CC\u062A (\u0628\u062F\u0648\u0646 \u0627\u0646\u062A\u0634\u0627\u0631 \u0639\u0645\u0648\u0645\u06CC)',
    emailLabel: '\u0627\u06CC\u0645\u06CC\u0644 \u0634\u0645\u0627 (\u0627\u062E\u062A\u06CC\u0627\u0631\u06CC \u2014 \u0627\u06AF\u0631 \u0645\u0627\u06CC\u0644 \u0628\u0647 \u062F\u0631\u06CC\u0627\u0641\u062A \u067E\u0627\u0633\u062E \u0647\u0633\u062A\u06CC\u062F)',
    emailPlaceholder: '\u0645\u062B\u0644\u0627 name@example.com',
    submitBtn: '\u0627\u0631\u0633\u0627\u0644 \u062A\u0627\u0645\u0644',
    submitPrivateBtn: '\u0627\u0631\u0633\u0627\u0644 \u067E\u06CC\u0627\u0645 \u062E\u0635\u0648\u0635\u06CC',
    submitting: '\u062F\u0631 \u062D\u0627\u0644 \u0627\u0631\u0633\u0627\u0644...',
    noReflections: '\u0647\u0646\u0648\u0632 \u062A\u0627\u0645\u0644\u06CC \u062F\u0631 \u0627\u06CC\u0646 \u062F\u0633\u062A\u0647 \u0648\u062C\u0648\u062F \u0646\u062F\u0627\u0631\u062F.',
    loadingReflections: '\u062F\u0631 \u062D\u0627\u0644 \u0628\u0627\u0631\u06AF\u0630\u0627\u0631\u06CC \u062A\u0627\u0645\u0644\u0627\u062A\u2026',
    rateLimit: '\u0644\u0637\u0641\u0627 {wait} \u062B\u0627\u0646\u06CC\u0647 \u0642\u0628\u0644 \u0627\u0632 \u0627\u0631\u0633\u0627\u0644 \u0645\u062C\u062F\u062F \u0635\u0628\u0631 \u06A9\u0646\u06CC\u062F.',
    missingFields: '\u0644\u0637\u0641\u0627 \u0646\u0627\u0645 \u0648 \u062A\u0627\u0645\u0644 \u062E\u0648\u062F \u0631\u0627 \u0648\u0627\u0631\u062F \u06A9\u0646\u06CC\u062F.',
    tooLong: '\u0646\u0627\u0645 \u0628\u0627\u06CC\u062F \u06A9\u0645\u062A\u0631 \u0627\u0632 \u06F3\u06F0 \u0648 \u062A\u0627\u0645\u0644 \u06A9\u0645\u062A\u0631 \u0627\u0632 \u06F5\u06F0\u06F0 \u06A9\u0627\u0631\u0627\u06A9\u062A\u0631 \u0628\u0627\u0634\u062F.',
    privateNotConfigured: '\u0627\u0631\u0633\u0627\u0644 \u067E\u06CC\u0627\u0645 \u062E\u0635\u0648\u0635\u06CC \u0647\u0646\u0648\u0632 \u067E\u06CC\u06A9\u0631\u0628\u0646\u062F\u06CC \u0646\u0634\u062F\u0647 \u0627\u0633\u062A.',
    sendFailed: '\u0627\u0631\u0633\u0627\u0644 \u067E\u06CC\u0627\u0645 \u0645\u0645\u06A9\u0646 \u0646\u0634\u062F. \u0644\u0637\u0641\u0627 \u062F\u0648\u0628\u0627\u0631\u0647 \u062A\u0644\u0627\u0634 \u06A9\u0646\u06CC\u062F.',
    firebaseNotReady: '\u0633\u06CC\u0633\u062A\u0645 \u0646\u0638\u0631\u0627\u062A \u0647\u0646\u0648\u0632 \u0645\u062A\u0635\u0644 \u0646\u06CC\u0633\u062A.',
    submitFailed: '\u0627\u0631\u0633\u0627\u0644 \u0645\u0645\u06A9\u0646 \u0646\u0634\u062F. \u0644\u0637\u0641\u0627 \u0627\u062A\u0635\u0627\u0644 \u0627\u06CC\u0646\u062A\u0631\u0646\u062A \u062E\u0648\u062F \u0631\u0627 \u0628\u0631\u0631\u0633\u06CC \u06A9\u0646\u06CC\u062F.',
    privateSent: '\u067E\u06CC\u0627\u0645 \u062E\u0635\u0648\u0635\u06CC \u0634\u0645\u0627 \u0627\u0631\u0633\u0627\u0644 \u0634\u062F. \u0633\u067E\u0627\u0633\u06AF\u0632\u0627\u0631\u06CC\u0645!',
    publicSent: '\u0627\u0632 \u0628\u0647 \u0627\u0634\u062A\u0631\u0627\u06A9\u200C\u06AF\u0630\u0627\u0631\u06CC \u062A\u0627\u0645\u0644 \u0634\u0645\u0627 \u0633\u067E\u0627\u0633\u06AF\u0632\u0627\u0631\u06CC\u0645!',
    loadFailed: '\u0628\u0627\u0631\u06AF\u0630\u0627\u0631\u06CC \u062A\u0627\u0645\u0644\u0627\u062A \u0645\u0645\u06A9\u0646 \u0646\u0634\u062F. \u0644\u0637\u0641\u0627 \u062F\u0648\u0628\u0627\u0631\u0647 \u062A\u0644\u0627\u0634 \u06A9\u0646\u06CC\u062F.',
    footerLink: '\u2190 \u0628\u0627\u0632\u06AF\u0634\u062A \u0628\u0647 \u062F\u0627\u0633\u062A\u0627\u0646 \u06CC\u0648\u0633\u0641',
    justNow: '\u0647\u0645\u06CC\u0646 \u0627\u0644\u0627\u0646',
    oneMinuteAgo: '\u06F1 \u062F\u0642\u06CC\u0642\u0647 \u067E\u06CC\u0634',
    minutesAgo: '{N} \u062F\u0642\u06CC\u0642\u0647 \u067E\u06CC\u0634',
    oneHourAgo: '\u06F1 \u0633\u0627\u0639\u062A \u067E\u06CC\u0634',
    hoursAgo: '{N} \u0633\u0627\u0639\u062A \u067E\u06CC\u0634',
    yesterday: '\u062F\u06CC\u0631\u0648\u0632',
    daysAgo: '{N} \u0631\u0648\u0632 \u067E\u06CC\u0634',
    oneMonthAgo: '\u06F1 \u0645\u0627\u0647 \u067E\u06CC\u0634',
    monthsAgo: '{N} \u0645\u0627\u0647 \u067E\u06CC\u0634',
    translatedFrom: '\u062A\u0631\u062C\u0645\u0647 \u0634\u062F\u0647 \u0627\u0632 \u0627\u0646\u06AF\u0644\u06CC\u0633\u06CC',
    translatedFromFa: '\u062A\u0631\u062C\u0645\u0647 \u0634\u062F\u0647 \u0627\u0632 \u0641\u0627\u0631\u0633\u06CC',
    showOriginal: '\u0646\u0645\u0627\u06CC\u0634 \u0645\u062A\u0646 \u0627\u0635\u0644\u06CC',
    showTranslation: '\u0646\u0645\u0627\u06CC\u0634 \u062A\u0631\u062C\u0645\u0647',
    translating: '\u062F\u0631 \u062D\u0627\u0644 \u062A\u0631\u062C\u0645\u0647...',
    translationFailed: '\u062A\u0631\u062C\u0645\u0647 \u062F\u0631 \u062F\u0633\u062A\u0631\u0633 \u0646\u06CC\u0633\u062A'
  }
};

// ── Category Definitions ──
const CATEGORIES = [
  { key: 'positive', icon: '&#x2728;', labelKey: 'catPositive' },
  { key: 'differences', icon: '&#x1F50D;', labelKey: 'catDifferences' },
  { key: 'insights', icon: '&#x1F4A1;', labelKey: 'catInsights' },
  { key: 'other', icon: '&#x1F4AC;', labelKey: 'catOther' }
];

// ── Helpers ──
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function timeAgo(timestamp) {
  const t = COMMENTS_I18N[currentLang];
  const seconds = Math.floor((Date.now() - timestamp) / 1000);
  if (seconds < 60) return t.justNow;
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes === 1 ? t.oneMinuteAgo : t.minutesAgo.replace('{N}', minutes);
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours === 1 ? t.oneHourAgo : t.hoursAgo.replace('{N}', hours);
  const days = Math.floor(hours / 24);
  if (days < 30) return days === 1 ? t.yesterday : t.daysAgo.replace('{N}', days);
  const months = Math.floor(days / 30);
  return months === 1 ? t.oneMonthAgo : t.monthsAgo.replace('{N}', months);
}

// ── Translation API ──
const translationCache = new Map();

async function translateText(text, fromLang, toLang) {
  const cacheKey = `${fromLang}|${toLang}|${text}`;
  if (translationCache.has(cacheKey)) {
    return translationCache.get(cacheKey);
  }

  try {
    const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${fromLang}|${toLang}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('Translation API error');
    const data = await res.json();

    if (data.responseStatus === 200 && data.responseData && data.responseData.translatedText) {
      const translated = data.responseData.translatedText;
      translationCache.set(cacheKey, translated);
      return translated;
    }
    throw new Error('No translation returned');
  } catch (err) {
    console.warn('Translation failed:', err.message);
    return null;
  }
}

// ── Build Category Sections ──
function buildCategorySections() {
  const t = COMMENTS_I18N[currentLang];
  const container = document.getElementById('commentsContainer');
  container.innerHTML = CATEGORIES.map(cat => `
    <div class="category-section open" data-category="${cat.key}">
      <div class="category-header" onclick="toggleCategory('${cat.key}')">
        <h3>
          <span class="category-icon">${cat.icon}</span>
          ${t[cat.labelKey]}
          <span class="category-count" id="count-${cat.key}">0</span>
        </h3>
        <span class="collapse-arrow">&#x25BC;</span>
      </div>
      <div class="category-body">
        <div class="category-body-inner" id="cards-${cat.key}">
          <div class="category-placeholder">${t.noReflections}</div>
        </div>
      </div>
    </div>
  `).join('');
}

// ── Toggle Collapse ──
function toggleCategory(key) {
  const section = document.querySelector(`.category-section[data-category="${key}"]`);
  section.classList.toggle('open');
}

// ── Toggle Original / Translated Text ──
function toggleOriginal(btn) {
  const card = btn.closest('.comment-text');
  const translated = card.querySelector('.comment-translated');
  const original = card.querySelector('.comment-original');
  const t = COMMENTS_I18N[currentLang];

  if (original.style.display === 'none') {
    original.style.display = '';
    translated.style.display = 'none';
    btn.textContent = t.showTranslation;
  } else {
    original.style.display = 'none';
    translated.style.display = '';
    btn.textContent = t.showOriginal;
  }
}

// ── Translate Visible Comments ──
async function translateVisibleComments() {
  const t = COMMENTS_I18N[currentLang];
  const cards = document.querySelectorAll('.comment-text[data-original-lang]');

  for (const card of cards) {
    const originalLang = card.getAttribute('data-original-lang');
    if (originalLang === currentLang) continue;

    const originalText = card.getAttribute('data-original');
    if (!originalText) continue;

    const statusEl = card.querySelector('.comment-translation-status');
    if (!statusEl) continue; // already translated

    const fromLang = originalLang === 'fa' ? 'fa' : 'en';
    const toLang = currentLang === 'fa' ? 'fa' : 'en';

    const translated = await translateText(originalText, fromLang, toLang);

    if (translated) {
      const translatedDir = currentLang === 'fa' ? 'rtl' : 'ltr';
      const originalDir = originalLang === 'fa' ? 'rtl' : 'ltr';
      const fromLabel = originalLang === 'fa' ? t.translatedFromFa : t.translatedFrom;

      card.innerHTML = `
        <span class="comment-translated" dir="${translatedDir}">${escapeHtml(translated)}</span>
        <div class="translation-note">
          <span class="translation-indicator">${fromLabel}</span>
          <button class="toggle-original-btn" onclick="toggleOriginal(this)">${t.showOriginal}</button>
        </div>
        <span class="comment-original" dir="${originalDir}" style="display:none;">${escapeHtml(originalText)}</span>
      `;
    } else if (statusEl) {
      statusEl.textContent = t.translationFailed;
    }
  }
}

// ── Render Comments ──
function renderComments(snapshot) {
  const t = COMMENTS_I18N[currentLang];
  const commentsByCategory = {
    positive: [],
    differences: [],
    insights: [],
    other: []
  };

  snapshot.forEach(child => {
    const data = child.val();
    const cat = commentsByCategory[data.category] ? data.category : 'other';
    commentsByCategory[cat].push(data);
  });

  // Sort newest first within each category
  for (const cat of Object.keys(commentsByCategory)) {
    commentsByCategory[cat].sort((a, b) => b.timestamp - a.timestamp);
  }

  // Render each category
  for (const cat of CATEGORIES) {
    const cards = commentsByCategory[cat.key];
    const container = document.getElementById(`cards-${cat.key}`);
    const countEl = document.getElementById(`count-${cat.key}`);
    countEl.textContent = cards.length;

    if (cards.length === 0) {
      container.innerHTML = `<div class="category-placeholder">${t.noReflections}</div>`;
    } else {
      container.innerHTML = cards.map(c => {
        const commentLang = c.lang || 'en';
        const needsTranslation = commentLang !== currentLang;
        const textDir = commentLang === 'fa' ? 'rtl' : 'ltr';

        if (needsTranslation) {
          return `
            <div class="comment-card">
              <div class="comment-meta">
                <span class="comment-author">${escapeHtml(c.name)}</span>
                <span class="comment-time">${timeAgo(c.timestamp)}</span>
              </div>
              <div class="comment-text" data-original="${escapeHtml(c.text)}" data-original-lang="${commentLang}">
                <span class="comment-original" dir="${textDir}">${escapeHtml(c.text)}</span>
                <span class="comment-translation-status">${t.translating}</span>
              </div>
            </div>`;
        } else {
          return `
            <div class="comment-card">
              <div class="comment-meta">
                <span class="comment-author">${escapeHtml(c.name)}</span>
                <span class="comment-time">${timeAgo(c.timestamp)}</span>
              </div>
              <div class="comment-text" dir="${textDir}">${escapeHtml(c.text)}</div>
            </div>`;
        }
      }).join('');
    }
  }

  // Trigger async translation for comments in a different language
  translateVisibleComments();
}

// ── Language Switching ──
function applyLanguage() {
  const t = COMMENTS_I18N[currentLang];
  const isFa = currentLang === 'fa';

  // RTL direction
  document.querySelector('.page-wrapper').setAttribute('dir', isFa ? 'rtl' : 'ltr');

  // Header
  document.getElementById('backLink').innerHTML = t.backLink;
  document.getElementById('pageTitle').textContent = t.pageTitle;
  document.getElementById('pageSubtitle').textContent = t.pageSubtitle;
  document.getElementById('langLabel').textContent = t.translationLabel;

  // Form
  document.getElementById('formTitle').textContent = t.formTitle;
  document.getElementById('nameLabel').textContent = t.nameLabel;
  document.getElementById('nameInput').placeholder = t.namePlaceholder;
  document.getElementById('categoryLabel').textContent = t.categoryLabel;

  const sel = document.getElementById('categorySelect');
  sel.options[0].textContent = t.catPositive;
  sel.options[1].textContent = t.catDifferences;
  sel.options[2].textContent = t.catInsights;
  sel.options[3].textContent = t.catOther;

  document.getElementById('reflectionLabel').textContent = t.reflectionLabel;
  document.getElementById('commentInput').placeholder = t.reflectionPlaceholder;
  document.getElementById('privateLabel').textContent = t.privateLabel;
  document.getElementById('emailLabel').textContent = t.emailLabel;
  document.getElementById('replyEmail').placeholder = t.emailPlaceholder;

  // Submit button (depends on private checkbox state)
  const isPrivate = document.getElementById('privateCheck').checked;
  document.getElementById('submitBtn').textContent = isPrivate ? t.submitPrivateBtn : t.submitBtn;

  // Footer
  document.getElementById('footerLink').innerHTML = t.footerLink;

  // Toggle button active states
  document.querySelectorAll('#langToggle button').forEach(btn => {
    btn.classList.toggle('active-lang', btn.dataset.lang === currentLang);
  });

  // Rebuild category sections with translated labels
  buildCategorySections();

  // Re-render comments if data is loaded
  if (firebaseReady && latestSnapshot) {
    renderComments(latestSnapshot);
  }
}

function switchLanguage(lang) {
  if (lang === currentLang) return;
  currentLang = lang;
  localStorage.setItem('lang', lang);
  applyLanguage();
}

// ── Form Submission ──
let lastSubmitTime = 0;

document.getElementById('commentForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const t = COMMENTS_I18N[currentLang];

  const msgEl = document.getElementById('formMessage');
  const btn = document.getElementById('submitBtn');

  // Rate limit: 30 seconds between submissions
  const now = Date.now();
  if (now - lastSubmitTime < 30000) {
    const wait = Math.ceil((30000 - (now - lastSubmitTime)) / 1000);
    msgEl.className = 'form-message error';
    msgEl.textContent = t.rateLimit.replace('{wait}', wait);
    return;
  }

  const name = document.getElementById('nameInput').value.trim();
  const text = document.getElementById('commentInput').value.trim();
  const category = document.getElementById('categorySelect').value;

  if (!name || !text) {
    msgEl.className = 'form-message error';
    msgEl.textContent = t.missingFields;
    return;
  }

  if (name.length > 30 || text.length > 500) {
    msgEl.className = 'form-message error';
    msgEl.textContent = t.tooLong;
    return;
  }

  const isPrivate = document.getElementById('privateCheck').checked;

  btn.disabled = true;
  btn.textContent = t.submitting;
  msgEl.textContent = '';

  if (isPrivate) {
    // Send via EmailJS (not saved publicly)
    if (!emailjsReady) {
      msgEl.className = 'form-message error';
      msgEl.textContent = t.privateNotConfigured;
      btn.disabled = false;
      btn.textContent = t.submitPrivateBtn;
      return;
    }

    try {
      await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, {
        from_name: name,
        message: text,
        reply_email: document.getElementById('replyEmail').value.trim() || 'Not provided'
      });

      lastSubmitTime = Date.now();
      document.getElementById('commentInput').value = '';
      document.getElementById('replyEmail').value = '';
      msgEl.className = 'form-message success';
      msgEl.textContent = t.privateSent;
      btn.disabled = false;
      btn.textContent = t.submitPrivateBtn;
      setTimeout(() => { msgEl.textContent = ''; }, 4000);
    } catch (err) {
      console.error('Error sending private message:', err);
      msgEl.className = 'form-message error';
      msgEl.textContent = t.sendFailed;
      btn.disabled = false;
      btn.textContent = t.submitPrivateBtn;
    }
  } else {
    // Save publicly to Firebase
    if (!firebaseReady) {
      msgEl.className = 'form-message error';
      msgEl.textContent = t.firebaseNotReady;
      btn.disabled = false;
      btn.textContent = t.submitBtn;
      return;
    }

    try {
      await commentsRef.push({
        name: name,
        text: text,
        category: category,
        timestamp: Date.now(),
        lang: currentLang
      });

      lastSubmitTime = Date.now();
      document.getElementById('commentInput').value = '';
      msgEl.className = 'form-message success';
      msgEl.textContent = t.publicSent;
      btn.disabled = false;
      btn.textContent = t.submitBtn;
      setTimeout(() => { msgEl.textContent = ''; }, 4000);
    } catch (err) {
      console.error('Error submitting comment:', err);
      msgEl.className = 'form-message error';
      msgEl.textContent = t.submitFailed;
      btn.disabled = false;
      btn.textContent = t.submitBtn;
    }
  }
});

// ── Toggle private mode UI ──
document.getElementById('privateCheck').addEventListener('change', function() {
  const t = COMMENTS_I18N[currentLang];
  const btn = document.getElementById('submitBtn');
  const catRow = document.getElementById('categoryRow');
  const emailRow = document.getElementById('replyEmailRow');
  if (this.checked) {
    btn.textContent = t.submitPrivateBtn;
    catRow.style.display = 'none';
    emailRow.style.display = '';
  } else {
    btn.textContent = t.submitBtn;
    catRow.style.display = '';
    emailRow.style.display = 'none';
  }
});

// ── Language Toggle Listeners ──
document.querySelectorAll('#langToggle button').forEach(btn => {
  btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
});

// ── Initialize ──
buildCategorySections();
applyLanguage();

if (firebaseReady) {
  // Listen for real-time updates
  commentsRef.on('value', (snapshot) => {
    latestSnapshot = snapshot;
    renderComments(snapshot);
  }, (err) => {
    const t = COMMENTS_I18N[currentLang];
    console.error('Firebase read error:', err);
    document.getElementById('commentsContainer').innerHTML =
      `<div class="loading-comments">${t.loadFailed}</div>`;
  });
} else {
  // Show setup message
  document.getElementById('commentsContainer').innerHTML =
    '<div class="loading-comments">Comments will appear here once Firebase is connected.</div>';
  buildCategorySections();
}
</script>
</body>
</html>
